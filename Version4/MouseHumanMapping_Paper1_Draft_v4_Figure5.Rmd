---
title: "Mouse Human Mapping Paper 1"
subtitle: "Figure 5"
author: "Antoine Beauchamp"
date: 'November 3rd, 2021'
output: html_document
---

```{r libraries}
#Libraries
suppressPackageStartupMessages(library(tidyverse))
library(grid)
library(gridExtra)
library(pheatmap)
library(ggplotify)
library(ggnewscale)
library(RMINC)
library(MRIcrotome)
library(data.tree)
library(RColorBrewer)
```

```{r functions}
#Functions
source("/projects/abeauchamp/Functions/TreeTools.R")
source("/projects/abeauchamp/Functions/mincBuildArray.R")
source("/projects/abeauchamp/Projects/MouseHumanMapping/Functions/ProcessingTools.R")
source("/projects/abeauchamp/Projects/MouseHumanMapping/Functions/buildSimilarityMatrix.R")
```

```{r import}
#Set path
pathHome <- "/projects/abeauchamp/Projects/MouseHumanMapping/Paper_Descriptive/"

#Import data
dfExprMouse <- suppressMessages(read_csv(str_c(pathHome, "Data/", "MouseExpressionMatrix_Voxel_coronal_maskcoronal_imputed_labelled.csv")))
dfExprHuman <- suppressMessages(read_csv(str_c(pathHome, "Data/", "HumanExpressionMatrix_Samples_labelled.csv")))

#Load mouse/human labels (Objects: listLabelsMouseReordered, listLabelsHumanReordered)
load(str_c(pathHome, "Data/", "TreeLabelsReordered.RData"))

#Import MICe data tree
load(str_c("/projects/abeauchamp/Projects/MouseHumanMapping/AllenMouseBrainAtlas/Data/MouseExpressionTree_DSURQE.RData"))
treeMouse <- Clone(treeMouseExpr)
rm(treeMouseExpr)

#Remove white matter and ventricles
pruneAnatTree(treeMouse, 
              nodes = c("fiber tracts", "ventricular systems"),
              method = "AtNode")

#Import AHBA data tree
load("/projects/abeauchamp/Projects/MouseHumanMapping/AllenHumanBrainAtlas/Data/HumanExpressionTree_Samples.RData")
treeHuman <- Clone(treeHumanExpr)
rm(treeHumanExpr)

#Fix human colour names (need to start with #)
treeHuman$Do(function(node){
  node$color_hex_triplet <- str_c("#", node$color_hex_triplet)
})

#Remove white matter and ventricles
pruneAnatTree(treeHuman,
              nodes = c("white matter", "sulci & spaces"),
              method = "AtNode")

#Import DSURQE labels and template
dsurqeLabels <- mincGetVolume("/projects/abeauchamp/Atlases/DSURQE/DSURQE_40micron_labels.mnc")
dsurqeAnat <- mincGetVolume("/projects/abeauchamp/Atlases/DSURQE/DSURQE_40micron_average.mnc")
dsurqeMask <- mincGetVolume("/projects/abeauchamp/Atlases/DSURQE/DSURQE_40micron_mask.mnc")
```

```{r normalization}
#Extract labels from data frames
dfLabelsMouse <- dfExprMouse %>% select(contains("Region"))
dfLabelsHuman <- dfExprHuman %>% select(contains("Region"))

#Normalize mouse data
dfExprMouse_scaled <- dfExprMouse %>% 
  select(-contains("Region")) %>% 
  as.matrix() %>% 
  scaler(axis = "rows") %>% 
  scaler(scale = FALSE, axis = "columns") %>% 
  as_tibble() %>% 
  bind_cols(dfLabelsMouse)

#Normalize human data
dfExprHuman_scaled <- dfExprHuman %>% 
  select(-contains("Region")) %>% 
  as.matrix() %>% 
  scaler(axis = "rows") %>% 
  scaler(scale = FALSE, axis = "columns") %>% 
  as_tibble() %>% 
  bind_cols(dfLabelsHuman)

#Extract genes list from mouse data (same as human)
genes <- colnames(dfExprMouse_scaled)[!str_detect(colnames(dfExprMouse_scaled), "Region")]

rm(dfExprMouse, dfExprHuman)
```

```{r results2-fig2-processing}
#Path to MLP files
pathMLP <- str_c(pathHome, "Data/MultilayerPerceptronOutcomes/")

#Files containing latent space representations
filesMLP_Mouse <- list.files(pathMLP, pattern = "MouseTx", full.names = T)
filesMLP_Human <- list.files(pathMLP, pattern = "HumanTx", full.names = T)

#Import the mouse latent space data
listMouseLatentSpace <- map(filesMLP_Mouse,
                            function(x){
                              suppressMessages(read_csv(x)) %>% 
                                column_to_rownames("Region") %>% 
                                as.matrix() %>% 
                                t()
                            })

#Import the human latent space data
listHumanLatentSpace <- map(filesMLP_Human,
                            function(x){
                              suppressMessages(read_csv(x)) %>% 
                                column_to_rownames("Region") %>% 
                                as.matrix() %>% 
                                t()
                            })

#Compute the latent space similarity matrices
listSimLatentSpace <- map2(listHumanLatentSpace, listMouseLatentSpace,
                           function(x1, x2){
                             m <- buildSimilarityMatrix(x1 = x1, x2 = x2)
                             m <- m[,match(listLabelsMouseReordered$Region67_reordered, colnames(m))]
                             m <- m[match(listLabelsHumanReordered$Region88_reordered, rownames(m)),]
                           })
names(listSimLatentSpace) <- str_c("MLP_v", 1:length(listSimLatentSpace))
rm(listMouseLatentSpace, listHumanLatentSpace)
```

```{r results3-fig5-processing}
#' Compute scaled similarity profiles for every column in a similarity matrix
#'
#' @param similarity A similarity matrix
#' @param scale A logical value indicating whether to scale the similarity profiles
#'
#' @return A tibble containing the scaled similarity profiles
computeSimilarityProfiles <- function(similarity, scale = FALSE){
  
  profiles <- tibble()
  for(seed in colnames(similarity)){
    temp <- similarity[, seed] %>% 
      enframe(name = "Target",
              value = "Similarity") 
      
      if(scale){
        temp <- temp %>% 
          mutate(Similarity = (Similarity - min(Similarity))/(max(Similarity) - min(Similarity)))
      }
    
    temp <- temp %>% 
      mutate(TargetRank = as.numeric(factor(Target, levels = Target[order(Similarity, decreasing = TRUE)])),
             Seed = seed)
    profiles <- bind_rows(profiles, temp)
  }
  return(profiles)
}


#Compute similarity profiles in MLP latent spaces
dfSimilarityProfiles <- map_dfr(.x = listSimLatentSpace,
                                .f = computeSimilarityProfiles,
                                .id = "Data")

#Generate a mouse tree with 67 leaf nodes
treeMouse_67 <- Clone(treeMouse)
pruneAnatTree(treeMouse_67,
              nodes = listLabelsMouseReordered$Region67_reordered,
              method = "BelowNode")

#Extracts mouse regions in isocortex
treeMouse_Cx <- FindNode(treeMouse_67, "Isocortex")
structsMouse_Cx <- treeMouse_Cx$Get("name", filterFun = isLeaf)

#Filter similarity profiles for isocortical regions
dfSimilarityProfiles_Cx <- dfSimilarityProfiles %>% 
  filter(Seed %in% structsMouse_Cx)

#Define sensory isocortical regions
structsMouse_Cx_sensory <- c("Primary auditory area",
                             "Dorsal auditory area",
                             "Ventral auditory area",
                             "Primary motor area",
                             "Secondary motor area",
                             "Primary somatosensory area",
                             "Supplemental somatosensory area",
                             "Visual areas")

#Define association isocortical regions
structsMouse_Cx_association <- structsMouse_Cx[!(structsMouse_Cx %in% structsMouse_Cx_sensory)]
```

```{r results3-fig5-panelA-regional}
#Identify maximal similarity values for every seed and data set
dfSimilarityProfiles_Cx_MaxSim <- dfSimilarityProfiles_Cx %>%
  group_by(Data, Seed) %>% 
  filter(Similarity == max(Similarity)) %>% 
  ungroup()

#Compute maximal similarity summary statistics for each isocortical region
dfSimilarityProfiles_Cx_MaxSim_Summary <- dfSimilarityProfiles_Cx_MaxSim %>% 
  group_by(Seed) %>% 
  summarise(SimilarityMean = mean(Similarity),
            SimilaritySdLower = SimilarityMean - 2*sd(Similarity),
            SimilaritySdUpper = SimilarityMean + 2*sd(Similarity)) %>% 
  ungroup() %>% 
  mutate(Seed = factor(Seed, levels = Seed[order(SimilarityMean)]),
         CortexType = ifelse(Seed %in% structsMouse_Cx_sensory, "Sensorimotor", "Association"))

fig5_regionaldist <- ggplot(dfSimilarityProfiles_Cx_MaxSim_Summary, 
       aes(x = Seed, 
           y = SimilarityMean,
           ymin = SimilaritySdLower,
           ymax = SimilaritySdUpper,
           col = CortexType)) + 
  geom_pointrange() + 
  coord_flip() +
  scale_colour_manual(values = c("#B27700", "#00325C")) +
  labs(x = "Mouse isocortical regions",
       y = "Maximal correlation",
       col = "Type of cortex") + 
  theme_bw() + 
  theme(legend.title = element_blank(),
        legend.position = "bottom",
        legend.direction = "horizontal",
        plot.margin = margin(l = 0, r = 0, b = 0, t = 0, unit = 'inch'))
fig5_regionaldist_grob <- ggplotGrob(fig5_regionaldist) %>% grid.force()

#Extract legend from plot
fig5_regionaldist_legend_grob <- getGrob(fig5_regionaldist_grob, "guides.3-3-3-3")
fig5_regionaldist <- fig5_regionaldist + 
  theme(legend.position = "none")
fig5_regionaldist_grob <- ggplotGrob(fig5_regionaldist) %>% grid.force()
```

```{r results3-fig5-panelB-cortextype}
#Compute mean maximal similarity per cortex type and data set
dfSimilarityProfiles_Cx_MaxSim_Compare <- dfSimilarityProfiles_Cx_MaxSim %>% 
  mutate(CortexType = ifelse(Seed %in% structsMouse_Cx_sensory, "Sensorimotor", "Association")) %>% 
  group_by(Data, CortexType) %>% 
  summarise(SimilarityMean = mean(Similarity)) %>%
  ungroup()

#Set seed for jittering
set.seed(123)

#Plot
fig5_cortexdist <- ggplot(dfSimilarityProfiles_Cx_MaxSim_Compare,
       aes(x = CortexType, y = SimilarityMean)) + 
  geom_jitter(width = 0.2,
              col = "grey80",
              size = 1) + 
  geom_boxplot(outlier.shape = NA,
               alpha = 0.3) + 
  labs(x = "Type of cortex",
       y = "Average maximal correlation") + 
  theme_bw() + 
  theme(plot.margin = margin(l = 0, r = 0, b = 0, t = 0, unit = 'inch'))
fig5_cortexdist_grob <- ggplotGrob(fig5_cortexdist) %>% grid.force()
```

```{r results3-fig5-grob}
#Figure 5 title grob
fig5_title <- textGrob("Conservation of mouse cortical sensorimotor and association areas",
                       x =  0.65)

#Generate figure 5 grob
# fig5_grob <- arrangeGrob(fig5_regionaldist_grob, #1
#                          fig5_regionaldist_legend_grob, #2
#                          fig5_regionaldist_title_grob, #3
#                          fig5_cortexdist_grob, #4
#                          fig5_cortexdist_title_grob, #5
#                          layout_matrix = rbind(c(NA,  3, 3, NA,  5, NA),
#                                                c(NA,  1, 1, NA,  4, NA),
#                                                c(NA, NA, 2, NA, NA, NA)),
#                          widths = unit(c(0.2, 2.238, 2.238, 0.25, 2.875, 0.2), 'inch'),
#                          heights = unit(c(0.25, 4.2, 0.25), 'inch'))
fig5_grob <- arrangeGrob(fig5_regionaldist_grob, #1
                         fig5_regionaldist_legend_grob, #2
                         fig5_cortexdist_grob, #3
                         fig5_title, #4
                         layout_matrix = rbind(c(NA,  4,  4,  4,  4, NA),
                                               c(NA,  1,  1, NA,  3, NA),
                                               c(NA, NA,  2, NA, NA, NA),
                                               c(NA, NA, NA, NA, NA, NA)),
                         widths = unit(c(0.2, 2.238, 2.238, 0.25, 2.875, 0.2), 'inch'),
                         heights = unit(c(0.4, 4.2, 0.25, 0.2), 'inch'))
```

```{r results3-fig5-interactive, include=TRUE, echo=FALSE, fig.width=8, fig.height=5.2}
grid.newpage()
grid.draw(fig5_grob)
grid.rect(gp = gpar(fill = NA))
grid.text(c("A.", "B."),
          x = unit(c(0.29, 5.02), 'inch'),
          y = unit(rep(0.88, 2), 'npc'),
          gp = gpar(fontsize = 14, fontface = "bold"))
```

```{r results3-fig5-write}
fileout <- str_c(pathHome, "Draft/", "Version4/", "Figure5.RData")
save(fig5_grob,
     file = fileout)
```

# Supplementary


I'm not sure what to look at here. I feel like this is a mess. 

Anterior-posterior gradient?
Sensory vs supramodal?
Random?

How do I parse this out?

First let's look at highest proportion for each mouse seed

```{r}
#Identify maximal similarity values for every seed and data set
dfSimilarityProfiles_Cx_MaxSim <- dfSimilarityProfiles_Cx %>%
  group_by(Data, Seed) %>% 
  filter(Similarity == max(Similarity)) %>% 
  ungroup()

#List of human cerebral lobes
structsHuman_Cx_16 <- c("limbic lobe", "frontal lobe", "insula", "occipital lobe","parietal lobe", "temporal lobe")

#Get a list of fine human regions in the cortex (excluding hippocampal regions)
structsHuman_Cx <- dfLabelsHuman %>% 
  select(Region16, Region88) %>% 
  distinct() %>% 
  filter(Region16 %in% structsHuman_Cx_16) %>% 
  filter(!(Region88 %in% c("claustrum", "dentate gyrus", "CA1 field", "CA2 field", "CA3 field", "CA4 field", "subiculum"))) %>% 
  mutate(Region88 = factor(Region88, levels = listLabelsHumanReordered$Region88_reordered)) %>% 
  arrange(Region88) %>% 
  pull(Region88) %>% 
  as.character()

#Combination of all mouse and human cortical regions
dfCombinations <- expand_grid(Seed = c(structsMouse_Cx),
                              Target = c(structsHuman_Cx, "Not cortical"))

#Compute proportion of latent spaces and average similarity for mouse-human Cx pairs
dfCortex_MaxSim_Summary <- dfSimilarityProfiles_Cx_MaxSim %>% 
  mutate(Target = ifelse(Target %in% structsHuman_Cx, Target, "Not cortical")) %>% 
  group_by(Seed, Target) %>% 
  summarise(prop = n()/500,
            avgSimilarity = mean(Similarity)) %>% 
  ungroup()

#Fill in pairs where proportion is 0
dfCortex_MaxSim_Summary <- dfCortex_MaxSim_Summary %>% 
  right_join(dfCombinations,
             by = c("Seed", "Target")) %>% 
  mutate(prop = ifelse(is.na(prop), 0, prop))

#Get mouse levels based on average maximal similarity
lvlsCortexMouse <- dfSimilarityProfiles_Cx_MaxSim_Summary %>% 
  pull(Seed) %>% 
  sort() %>% 
  as.character()

#Identify which proportion value is maximal for each mouse Cx region
dfCortex_MaxSim_Summary <- dfCortex_MaxSim_Summary %>% 
  group_by(Seed) %>% 
  mutate(IsMaxProp = ifelse(prop == max(prop), 1, 0)) %>% 
  ungroup() %>% 
  mutate(IsMaxProp = factor(IsMaxProp),
         Seed = factor(Seed, levels = lvlsCortexMouse))
```

For every mouse isocortical region, what is the human match that occurs in the highest proportion of latent spaces? 

```{r}
dfCortex_MaxSim_Summary %>% 
  filter(IsMaxProp == 1) %>% 
  select(Seed, Target, prop) %>% 
  arrange(desc(Seed))
```

```{r fig.width = 10}
#Isolate those pairs with the highest proportions
dfCortex_MaxSim_Summary_MaxProp <- dfCortex_MaxSim_Summary %>% 
  filter(IsMaxProp == 1) %>% 
  mutate(y = 1)

#Start building data frame with AHBA colours
dfColoursHuman <- dfLabelsHuman %>% 
  select(Region88, Region16) %>% 
  distinct() %>% 
  mutate(Region16 = ifelse(Region16 %in% structsHuman_Cx_16, Region16, "Not cortical"),
         Region88 = ifelse(Region16 == "Not cortical", "Not cortical", Region88)) %>% 
  distinct()

#Generate human tree with 16 broad regions
treeHuman_16 <- Clone(treeHuman)
pruneAnatTree(treeHuman_16,
              nodes = listLabelsHumanReordered$Region16_reordered,
              method = "BelowNode")

#Get colours for cerebral lobes
dfColoursHuman <- treeHuman_16$Get("color_hex_triplet", filterFun = isLeaf) %>%
  enframe(name = "Region16",
          value = "color_hex_triplet") %>% 
    right_join(dfColoursHuman,
               by = "Region16") %>% 
    mutate(color_hex_triplet = ifelse(Region16 == "Not cortical", "black", color_hex_triplet))

#Add colours to max prop data frame
dfCortex_MaxSim_Summary_MaxProp <- dfCortex_MaxSim_Summary_MaxProp %>% 
  left_join(dfColoursHuman,
            by = c("Target" = "Region88")) %>% 
  mutate(Seed = factor(Seed, levels = lvlsCortexMouse),
         Target = factor(Target, levels = c(structsHuman_Cx, "Not cortical")),
         Region16 = factor(Region16, levels = c(structsHuman_Cx_16, "Not cortical")))

#Extract colour palette for human cerebral lobes
coloursHuman <- dfCortex_MaxSim_Summary_MaxProp %>% 
  select(Region16, color_hex_triplet) %>% 
  distinct() %>% 
  arrange(Region16) %>% 
  pull(color_hex_triplet)


library(ggalluvial)
plotCxAlluvial_prop <- ggplot(dfCortex_MaxSim_Summary_MaxProp,
       aes(axis1 = fct_rev(Seed), axis2 = Target, y = y)) + 
  geom_alluvium(aes(fill = prop),
                col = "grey50") + 
  geom_stratum() + 
  geom_text(stat = "stratum",
            aes(label = after_stat(stratum),
                col = Region16),
            size = 3, fontface = "bold") + 
  scale_x_discrete(limits = c("Mouse", "Human"), expand = expansion(mult = 0.1)) + 
  scale_fill_distiller(palette = "Blues", direction = 1) +
  scale_colour_manual(values = coloursHuman) + 
  labs(fill = "Proportion of latent spaces",
       col = "Human cerebral lobes",
       title = "Human regions maximally similar to mouse isocortical regions\nin the highest proportion of latent spaces",
       caption = "Mouse regions ordered according to average maximal correlation\nHuman regions ordered anatomically") + 
  theme_minimal() + 
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(face = "bold", size = 12),
        panel.grid = element_blank())
plotCxAlluvial_prop
```

```{r fig.width=10}
plotCxAlluvial_avgSim <- ggplot(dfCortex_MaxSim_Summary_MaxProp,
       aes(axis1 = fct_rev(Seed), axis2 = Target, y = y)) + 
  geom_alluvium(aes(fill = avgSimilarity),
                col = "grey50") + 
  geom_stratum() + 
  geom_text(stat = "stratum",
            aes(label = after_stat(stratum),
                col = Region16),
            size = 3, fontface = "bold") + 
  scale_x_discrete(limits = c("Mouse", "Human"), expand = expansion(mult = 0.1)) + 
  scale_fill_distiller(palette = "Blues", direction = 1) +
  scale_colour_manual(values = coloursHuman) + 
  labs(fill = "Average correlation",
       col = "Human cerebral lobes",
       title = "Human regions maximally similar to mouse isocortical regions\nin the highest proportion of latent spaces",
       caption = "Mouse regions ordered according to average maximal correlation\nHuman regions ordered anatomically") + 
  theme_minimal() + 
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(face = "bold", size = 12),
        panel.grid = element_blank())
plotCxAlluvial_avgSim
```


```{r fig.width=10}
#Include colours to max similarity summary data frame
dfCortex_MaxSim_Summary_wColours <- dfCortex_MaxSim_Summary %>% 
  left_join(dfLabelsHuman %>% 
              select(Region16, Region88) %>% 
              distinct(),
            by = c("Target" = "Region88")) %>% 
  mutate(Target = factor(Target, levels = c(structsHuman_Cx, "Not cortical"))) %>% 
  left_join(dfColoursHuman %>% 
              select(Region16, color_hex_triplet) %>% 
              distinct(),
            by = "Region16") %>% 
  mutate(Region16 = ifelse(is.na(Region16), "Not cortical", Region16),
         color_hex_triplet = ifelse(is.na(color_hex_triplet), "white", color_hex_triplet),
         Region16 = factor(Region16, levels = c(structsHuman_Cx_16, "Not cortical")))

coloursHuman <- dfCortex_MaxSim_Summary_wColours %>%
  select(Region16, color_hex_triplet) %>% 
  distinct() %>% 
  arrange(Region16) %>% 
  pull(color_hex_triplet)

#Recode zero proportions as NA
dfCortex_MaxSim_Summary_wColours <- dfCortex_MaxSim_Summary_wColours %>% mutate(prop = ifelse(prop == 0, NA, prop))

plotCx_Dotmap_prop <- ggplot(dfCortex_MaxSim_Summary_wColours, aes(x = Target, y = Seed)) + 
  geom_tile(aes(fill = Region16),
            col = "grey50",
            alpha = 0.7) + 
  geom_point(aes(size = prop, col = IsMaxProp),
             na.rm = T) + 
  scale_fill_manual(values = coloursHuman) + 
  scale_size_continuous(range = c(0, 4)) + 
  scale_color_manual(values = c("grey50", "black")) + 
    labs(x = "Human cortical target",
         y = "Mouse isocortical seed",
         fill = "Human cerebral lobes",
         col = "Highest proportion?",
         size = "Proportion of latent spaces",
         caption = "Mouse regions ordered using average maximal correlation\nHuman regions ordered anatomically\nColumns sum to 1",
         title = "Proportion of latent spaces in which mouse isocortical regions are\nmaximally similar to human target regions") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
plotCx_Dotmap_prop
```

```{r fig.width=10}
plotCx_Dotmap_avgSim <- ggplot(dfCortex_MaxSim_Summary_wColours, aes(x = Target, y = Seed)) + 
  geom_tile(aes(fill = Region16),
            col = "grey50",
            alpha = 0.7) + 
  geom_point(aes(size = avgSimilarity, col = IsMaxProp),
             na.rm = T) + 
  scale_fill_manual(values = coloursHuman) + 
  scale_size_continuous(range = c(0, 4)) + 
  scale_color_manual(values = c("grey50", "black")) + 
    labs(x = "Human cortical target",
         y = "Mouse isocortical seed",
         fill = "Human cerebral lobes",
         col = "Highest proportion?",
         size = "Average correlation",
         caption = "Mouse regions ordered using average maximal correlation\nHuman regions ordered anatomically",
         title = "Proportion of latent spaces in which mouse isocortical regions are\nmaximally similar to human target regions") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
plotCx_Dotmap_avgSim
```


```{r}
dfCortex_MaxSim_Summary_wColours %>% 
  filter(Seed == "Primary somatosensory area") %>% 
  filter(prop != 0) %>% 
  select(Seed, Target, Proportion = prop, AvgCorrelation = avgSimilarity) %>% 
  arrange(desc(Proportion))
```

```{r fig.width = 10, fig.height = 5}
#Create a data frame containing average correlation between mouse S1 and human cortical regions
dfSimilarity_S1_Summary <- dfSimilarityProfiles_Cx %>% 
  filter(Seed == "Primary somatosensory area") %>% 
  group_by(Target) %>% 
  summarise(SimilarityMean = mean(Similarity),
            SimilaritySd = sd(Similarity),
            SimilarityUpper = SimilarityMean + 2*SimilaritySd,
            SimilarityLower = SimilarityMean - 2*SimilaritySd) %>% 
  ungroup() %>% 
  inner_join(dfColoursHuman,
            by = c("Target" = "Region88")) %>% 
  mutate(Target = factor(Target, levels = Target[order(SimilarityMean)]),
         Region16 = factor(Region16, levels = structsHuman_Cx_16))

ggplot(dfSimilarity_S1_Summary, aes(x = fct_rev(Target), col = Region16)) + 
  geom_pointrange(aes(y = SimilarityMean, ymin = SimilarityLower, ymax = SimilarityUpper)) + 
  scale_color_manual(values = coloursHuman) + 
  labs(x = "Human cerebral target",
       y = "Correlation",
       col = "Human cerebral lobes",
       title = "Correlation between the human cerebrum and mouse S1") + 
  theme_dark() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


```{r}
#Compute aggregated expression matrix for all mouse regions
matExprMouse_scaled <- dfExprMouse_scaled %>% 
  select(Region67, genes) %>% 
  group_by(Region67) %>% 
  summarise_all(.funs = mean) %>% 
  ungroup() %>% 
  column_to_rownames("Region67") %>% 
  as.matrix() %>% 
  t()

#Compute aggregated expression matrix for all human regions
matExprHuman_scaled <- dfExprHuman_scaled %>% 
  select(Region88, genes) %>% 
  group_by(Region88) %>% 
  summarise_all(.funs = mean) %>% 
  ungroup() %>% 
  column_to_rownames("Region88") %>% 
  as.matrix() %>% 
  t()

#Compute similarity matrix in homologous gene space
matSim_AllGenes <- buildSimilarityMatrix(x1 = matExprHuman_scaled,
                                         x2 = matExprMouse_scaled)
```

What are the top matches to the mouse S1 in the original gene space?

```{r}
matSim_AllGenes[,"Primary somatosensory area"] %>% 
  enframe(name = "HumanRegion",
          value = "Correlation") %>% 
  inner_join(dfColoursHuman,
             by = c("HumanRegion" = "Region88")) %>% 
  mutate(HumanRegion = factor(HumanRegion, levels = HumanRegion[order(Correlation)])) %>% 
  arrange(desc(HumanRegion))
```

```{r}
matSim_Cx_MLP <- dfSimilarityProfiles_Cx %>% 
  filter(Seed %in% structsMouse_Cx,
         Target %in% structsHuman_Cx) %>% 
  group_by(Seed, Target) %>% 
  summarise(SimilarityMean = mean(Similarity)) %>% 
  ungroup() %>% 
  pivot_wider(id_cols = Target, names_from = Seed, values_from = SimilarityMean) %>% 
  column_to_rownames("Target") %>% 
  as.matrix()

matSim_Cx_AllGenes <- matSim_AllGenes[rownames(matSim_AllGenes) %in% structsHuman_Cx, colnames(matSim_AllGenes) %in% structsMouse_Cx]
```

```{r fig.width = 10, fig.height = 8}
# matSim_Cx_MLP_norm <- matSim_Cx_MLP/max(matSim_Cx_MLP)
clusteredHeatmap_MLP <- pheatmap(matSim_Cx_MLP, cluster_cols = T, cluster_rows  = T)
```

```{r fig.width = 10, fig.height = 8}
# matSim_Cx_AllGenes_norm <- matSim_Cx_AllGenes/max(matSim_Cx_AllGenes)
clusteredHeatmap_AllGenes <- pheatmap(matSim_Cx_AllGenes, cluster_cols = T, cluster_rows  = T)
```

```{r}
computeWCSS <- function(x, hc_tree){
  wcss_tot <- numeric(ncol(x))
  for(k in 1:ncol(x)){
    labs <- cutree(hc_tree, k = k)
    wcss_k <- numeric(k)
    for(c in 1:k){
      x_clust <- as.matrix(x[,labs == c])
      wcss_k[c] <- sum(colSums((x_clust - rowMeans(x_clust))^2))/ncol(x_clust)
    }
    wcss_tot[k] <- mean(wcss_k)
  }
  return(wcss_tot)
}

dfWCSS_Cols_MLP <- tibble(k = 1:ncol(matSim_Cx_MLP),
                          wcss = computeWCSS(x = matSim_Cx_MLP, clusteredHeatmap_MLP$tree_col),
                          data = "MLP",
                          axis = "Mouse")
dfWCSS_Cols_AllGenes <- tibble(k = 1:ncol(matSim_Cx_AllGenes),
                               wcss = computeWCSS(x = matSim_Cx_AllGenes, clusteredHeatmap_AllGenes$tree_col),
                               data = "AllGenes",
                               axis = "Mouse")

dfWCSS_Rows_MLP <- tibble(k = 1:nrow(matSim_Cx_MLP),
                          wcss = computeWCSS(x = t(matSim_Cx_MLP), clusteredHeatmap_MLP$tree_row),
                          data = "MLP",
                          axis = "Human")
dfWCSS_Rows_AllGenes <- tibble(k = 1:nrow(matSim_Cx_AllGenes),
                               wcss = computeWCSS(x = t(matSim_Cx_AllGenes), clusteredHeatmap_AllGenes$tree_row),
                               data = "AllGenes",
                               axis = "Human")

dfWCSS <- bind_rows(dfWCSS_Cols_MLP, dfWCSS_Cols_AllGenes, dfWCSS_Rows_AllGenes, dfWCSS_Rows_MLP)
```

```{r}
ggplot(dfWCSS, aes(x = k, y = wcss, col = data)) + 
  geom_line() + 
  geom_point() + 
  # facet_grid(data~axis, scales = "free_y") + 
  facet_wrap(~axis, nrow = 2, scales = "free_y") +
  coord_cartesian(xlim = c(1, 10),
                  ylim = c(0, 1)) + 
  scale_x_continuous(breaks = seq(0, 40, 1), expand = expansion(add = 0.5)) + 
  scale_color_discrete(labels = c("Homologous genes", "Average latent space")) + 
  labs(y = "Within-cluster sum of squared distances",
       col = "Data",
       title = "Hierarchical clustering of cerebral correlation values",
       caption = "Human: 40 clusters total; Mouse: 19 clusters total") + 
  theme_bw() + 
  theme(legend.position = "bottom")
```

```{r}
dfWCSS %>% 
  group_by(data, axis) %>% 
  mutate(wcss = wcss/max(wcss)) %>% 
  ungroup() %>% 
  ggplot(aes(x = k, y = wcss, col = data)) + 
  geom_line() + 
  geom_point() + 
  # facet_grid(data~axis, scales = "free_y") + 
  facet_wrap(~axis, nrow = 2) +
  coord_cartesian(xlim = c(1, 14),
                  ylim = c(0, 1)) + 
  scale_x_continuous(breaks = seq(0, 40, 1), expand = expansion(add = 0.5)) + 
  scale_color_discrete(labels = c("Homologous genes", "Average latent space")) + 
  labs(y = "Within-cluster sum of squared distances (normalized)",
       col = "Data",
       title = "Hierarchical clustering of cerebral correlation values",
       caption = "Human: 40 clusters total; Mouse: 19 clusters total") + 
  theme_bw() + 
  theme(legend.position = "bottom",
        panel.grid.minor.x = element_blank())
```


```{r}
getClusterLabels <- function(x, hc_tree){
  labels <- matrix(0, ncol = ncol(x), nrow = ncol(x))
  for(k in 1:ncol(x)){
    labels[,k] <- cutree(hc_tree, k = k)
  }
  rownames(labels) <- colnames(x)
  colnames(labels) <- str_c("k", 1:ncol(x))
  return(labels)
}

dfClustLabels_Cols_MLP <- getClusterLabels(x = matSim_Cx_MLP, hc_tree = clusteredHeatmap_MLP$tree_col) 
dfClustLabels_Cols_AllGenes <- getClusterLabels(x = matSim_Cx_AllGenes, hc_tree = clusteredHeatmap_AllGenes$tree_col) 
dfClustLabels_Rows_MLP <- getClusterLabels(x = t(matSim_Cx_MLP), hc_tree = clusteredHeatmap_MLP$tree_row) 
dfClustLabels_Rows_AllGenes <- getClusterLabels(x = t(matSim_Cx_AllGenes), hc_tree = clusteredHeatmap_AllGenes$tree_row) 
```

```{r}
library(mclustcomp)
for(nk in 1:ncol(dfClustLabels_Cols_MLP)){
  if (nk == 1){
    metrics <- as.character(mclustcomp(x = dfClustLabels_Cols_MLP[,nk], y = dfClustLabels_Cols_AllGenes[,nk])$types)
    matClustComp <- matrix(0, nrow = length(metrics), ncol = ncol(dfClustLabels_Cols_AllGenes),
                           dimnames = list(metrics, colnames(dfClustLabels_Cols_AllGenes)))
  }
  matClustComp[,nk] <- mclustcomp(x = dfClustLabels_Cols_MLP[,nk], y = dfClustLabels_Cols_AllGenes[,nk])$scores
}
```

```{r fig.width = 10, fig.height = 5}
dfClustComp <- matClustComp %>% 
  as_tibble(rownames = "metric") %>% 
  pivot_longer(cols = -metric, names_to = "nk", values_to = "score") %>% 
  mutate(nk = as.numeric(str_remove(nk, "k")))

dfClustComp %>% 
  filter(metric %in% c("sdc", "jaccard")) %>% 
  mutate(metric = ifelse(metric == "sdc", "dice", metric)) %>% 
  ggplot(aes(x = nk, y = score, col = metric)) +
  geom_line() + 
  geom_point() + 
  coord_cartesian(xlim = c(1, 19)) + 
  scale_x_continuous(breaks = seq(1, 30, 1)) + 
  labs(x = "Number of clusters",
       y = "Metric score",
       col = "Metric",
       title = "Mouse cortical cluster overlap between homologous genes and average latent space") + 
  theme_bw() + 
  theme(panel.grid.minor.x = element_blank())
```

```{r fig.width = 10, fig.height = 5}
for(nk in 1:ncol(dfClustLabels_Rows_MLP)){
  if (nk == 1){
    metrics <- as.character(mclustcomp(x = dfClustLabels_Rows_MLP[,nk], y = dfClustLabels_Rows_AllGenes[,nk])$types)
    matClustComp <- matrix(0, nrow = length(metrics), ncol = ncol(dfClustLabels_Rows_AllGenes),
                           dimnames = list(metrics, colnames(dfClustLabels_Rows_AllGenes)))
  }
  matClustComp[,nk] <- mclustcomp(x = dfClustLabels_Rows_MLP[,nk], y = dfClustLabels_Rows_AllGenes[,nk])$scores
}

dfClustComp <- matClustComp %>% 
  as_tibble(rownames = "metric") %>% 
  pivot_longer(cols = -metric, names_to = "nk", values_to = "score") %>% 
  mutate(nk = as.numeric(str_remove(nk, "k")))

dfClustComp %>% 
  filter(metric %in% c("sdc", "jaccard")) %>% 
  mutate(metric = ifelse(metric == "sdc", "dice", metric)) %>% 
  ggplot(aes(x = nk, y = score, col = metric)) +
  geom_line() + 
  geom_point() + 
  coord_cartesian(xlim = c(1, 40),
                  ylim = c(0, 1)) + 
  scale_x_continuous(breaks = seq(0, 50, 1),
                     expand = expansion(add = 1)) + 
  labs(x = "Number of clusters",
       y = "Metric score",
       col = "Metric",
       title = "Human cortical cluster overlap between homologous genes and average latent space") + 
  theme_bw() + 
  theme(panel.grid.minor.x = element_blank())
```

```{r fig.width = 10, fig.height = 8}
clusterOrder_cols <- names(sort(dfClustLabels_Cols_MLP[,"k4"]))
clusterOrder_rows <- names(sort(dfClustLabels_Rows_MLP[,"k4"]))

matSim_Cx_MLP_ordered <- matSim_Cx_MLP[match(clusterOrder_rows, rownames(matSim_Cx_MLP)),
                                       match(clusterOrder_cols, colnames(matSim_Cx_MLP))]

dfAnnotationsMouse <- inner_join(enframe(dfClustLabels_Cols_MLP[,"k4"],
                                         name = "MouseRegion",
                                         value = "Cluster_MLP"),
                                 enframe(dfClustLabels_Cols_AllGenes[,"k4"],
                                         name = "MouseRegion",
                                         value = "Cluster_AllGenes"),
                                 by = "MouseRegion") %>% 
  column_to_rownames("MouseRegion")
dfAnnotationsHuman <- inner_join(enframe(dfClustLabels_Rows_MLP[,"k4"],
                                         name = "HumanRegion",
                                         value = "Cluster_MLP"),
                                 enframe(dfClustLabels_Rows_AllGenes[,"k4"],
                                         name = "HumanRegion",
                                         value = "Cluster_AllGenes"),
                                 by = "HumanRegion") %>% 
  column_to_rownames("HumanRegion")

pheatmap(matSim_Cx_MLP_ordered,
         cluster_cols = F, cluster_rows = F,
         annotation_col = dfAnnotationsMouse,
         annotation_row = dfAnnotationsHuman)
```


```{r}
library(Rtsne)
tsne_out <- Rtsne(t(matSim_Cx_MLP), perplexity = 4)

df_tsne <- bind_cols(as_tibble(tsne_out$Y),
                     dfClustLabels_MLP)
```

```{r fig.width = 10, fig.asp 1}
library(ggrepel)
ggplot(df_tsne, aes(x = V1, y = V2, col = factor(k4))) + 
  geom_point() + 
  geom_text_repel(aes(label = Region), size = 2) + 
  # geom(aes(label = Region), size = 2, alpha = 0.5) + 
  theme_bw()
```


